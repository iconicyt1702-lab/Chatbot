<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, interactive-widget=resizes-content">
    <title>Universal AI Chat</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    colors: {
                        brand: { 500: '#3b82f6', 600: '#2563eb' },
                        dark: { bg: '#131314', surface: '#1e1f20', border: '#444746' }
                    }
                }
            }
        }
    </script>

    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dompurify/dist/purify.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>

    <style>
        /* Custom Scrollbar for Webkit */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .dark ::-webkit-scrollbar-thumb { background: #444746; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        /* Markdown Styles */
        .prose pre { padding: 0; margin: 0.5em 0; border-radius: 0.5rem; overflow: hidden; }
        .prose code { font-family: monospace; }
        .prose p { margin-bottom: 0.5rem; }
        .prose ul { list-style-type: disc; padding-left: 1.5rem; margin-bottom: 0.5rem; }
        .prose ol { list-style-type: decimal; padding-left: 1.5rem; margin-bottom: 0.5rem; }
        
        /* Typing Cursor Animation */
        .cursor-blink::after {
            content: 'â–‹';
            display: inline-block;
            animation: blink 1s step-start infinite;
            color: #3b82f6;
            margin-left: 2px;
        }
        @keyframes blink { 50% { opacity: 0; } }

        /* Mobile safe area handling */
        body { height: 100dvh; overflow: hidden; }
    </style>
</head>
<body class="bg-white dark:bg-dark-bg text-gray-900 dark:text-gray-100 flex transition-colors duration-200">

    <div id="app-loader" class="fixed inset-0 z-50 flex items-center justify-center bg-white dark:bg-dark-bg">
        <div class="flex flex-col items-center gap-4">
            <div class="w-8 h-8 border-4 border-brand-500 border-t-transparent rounded-full animate-spin"></div>
            <p class="text-sm text-gray-500 font-medium">Initializing AI Interface...</p>
        </div>
    </div>

    <aside id="sidebar" class="fixed inset-y-0 left-0 z-40 w-72 bg-gray-50 dark:bg-dark-surface border-r border-gray-200 dark:border-dark-border transform -translate-x-full md:translate-x-0 transition-transform duration-300 flex flex-col h-full">
        <div class="p-4 flex items-center justify-between">
            <button onclick="createNewChat()" class="flex-1 flex items-center gap-2 bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 text-sm font-medium py-2.5 px-4 rounded-full transition-colors">
                <i class="ph ph-plus text-lg"></i>
                <span>New Chat</span>
            </button>
            <button onclick="toggleSidebar()" class="md:hidden ml-2 p-2 text-gray-500 hover:text-gray-900 dark:hover:text-white">
                <i class="ph ph-x text-xl"></i>
            </button>
        </div>

        <div class="flex-1 overflow-y-auto px-2 space-y-1" id="chat-history-list">
            </div>

        <div class="p-4 border-t border-gray-200 dark:border-dark-border space-y-2">
            <button onclick="openModal('settings-modal')" class="flex w-full items-center gap-3 px-3 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-700 rounded-lg transition-colors">
                <i class="ph ph-gear text-lg"></i> Settings & API
            </button>
            <button onclick="toggleDarkMode()" class="flex w-full items-center gap-3 px-3 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-700 rounded-lg transition-colors">
                <i id="theme-icon" class="ph ph-moon text-lg"></i>
                <span id="theme-text">Dark Mode</span>
            </button>
        </div>
    </aside>

    <div id="sidebar-overlay" onclick="toggleSidebar()" class="fixed inset-0 bg-black/50 z-30 hidden md:hidden glass"></div>

    <main class="flex-1 flex flex-col h-full md:ml-72 relative transition-all">
        
        <header class="flex-none h-16 flex items-center justify-between px-4 border-b border-gray-100 dark:border-dark-border bg-white/90 dark:bg-dark-bg/90 backdrop-blur">
            <div class="flex items-center gap-3">
                <button onclick="toggleSidebar()" class="md:hidden p-2 -ml-2 text-gray-600 dark:text-gray-300">
                    <i class="ph ph-list text-xl"></i>
                </button>
                <div class="flex flex-col">
                    <h1 class="font-semibold text-lg flex items-center gap-2">
                        Universal AI <span class="text-xs bg-brand-500/10 text-brand-600 px-2 py-0.5 rounded-full border border-brand-500/20">Alpha</span>
                    </h1>
                    <span id="current-model-display" class="text-xs text-gray-500 truncate max-w-[200px]">deepseek/deepseek-r1:free</span>
                </div>
            </div>
            <div class="flex items-center gap-2">
                <button onclick="openModal('system-prompt-modal')" class="p-2 text-gray-500 hover:bg-gray-100 dark:hover:bg-dark-surface rounded-full" title="System Prompt">
                    <i class="ph ph-robot text-xl"></i>
                </button>
                <div class="relative group">
                    <button onclick="showChatOptions(event)" class="p-2 text-gray-500 hover:bg-gray-100 dark:hover:bg-dark-surface rounded-full">
                        <i class="ph ph-dots-three-vertical text-xl"></i>
                    </button>
                    <div id="chat-options-dropdown" class="hidden absolute right-0 top-full mt-2 w-48 bg-white dark:bg-dark-surface border border-gray-200 dark:border-dark-border rounded-lg shadow-xl py-1 z-20">
                        <button onclick="renameCurrentChat()" class="w-full text-left px-4 py-2 text-sm hover:bg-gray-100 dark:hover:bg-gray-700">Rename Chat</button>
                        <button onclick="deleteCurrentChat()" class="w-full text-left px-4 py-2 text-sm text-red-500 hover:bg-red-50 dark:hover:bg-red-900/20">Delete Chat</button>
                    </div>
                </div>
            </div>
        </header>

        <div id="messages-container" class="flex-1 overflow-y-auto p-4 md:p-8 space-y-6 scroll-smooth">
            <div id="welcome-view" class="h-full flex flex-col items-center justify-center text-center opacity-0 transition-opacity duration-500">
                <div class="bg-gradient-to-br from-blue-500 to-purple-600 w-16 h-16 rounded-2xl flex items-center justify-center mb-6 shadow-lg shadow-brand-500/30">
                    <i class="ph ph-sparkle text-3xl text-white"></i>
                </div>
                <h2 class="text-2xl font-semibold mb-2 bg-clip-text text-transparent bg-gradient-to-r from-blue-600 to-purple-600">How can I help you today?</h2>
                <p class="text-gray-500 dark:text-gray-400 max-w-md">I can write code, explain complex topics, or just chat. Configure your API key in settings to start.</p>
            </div>
            </div>

        <div class="flex-none p-4 bg-white dark:bg-dark-bg">
            <div class="max-w-4xl mx-auto relative">
                <div class="flex items-end gap-2 bg-gray-100 dark:bg-dark-surface p-2 rounded-[2rem] border border-transparent focus-within:border-gray-300 dark:focus-within:border-gray-600 transition-colors">
                    <textarea 
                        id="user-input" 
                        rows="1" 
                        class="w-full bg-transparent border-0 focus:ring-0 resize-none py-3 px-4 max-h-32 min-h-[48px] text-gray-900 dark:text-gray-100 placeholder-gray-500"
                        placeholder="Message AI..."
                        oninput="autoResize(this)"
                        onkeydown="handleEnter(event)"></textarea>
                    
                    <button id="send-btn" onclick="sendMessage()" class="p-3 bg-brand-600 text-white rounded-full hover:bg-brand-700 disabled:opacity-50 disabled:cursor-not-allowed transition-all flex-shrink-0 mb-1 mr-1">
                        <i class="ph ph-paper-plane-right text-lg"></i>
                    </button>
                </div>
                <div class="text-center mt-2">
                    <p class="text-[10px] text-gray-400">AI can make mistakes. Check important info.</p>
                </div>
            </div>
        </div>
    </main>

    <div id="settings-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm p-4">
        <div class="bg-white dark:bg-dark-surface w-full max-w-md rounded-2xl shadow-2xl overflow-hidden animate-fade-in-up">
            <div class="p-6 border-b border-gray-100 dark:border-dark-border flex justify-between items-center">
                <h3 class="text-lg font-semibold">Settings</h3>
                <button onclick="closeModal('settings-modal')" class="text-gray-500 hover:text-gray-900 dark:hover:text-white"><i class="ph ph-x text-xl"></i></button>
            </div>
            <div class="p-6 space-y-4">
                <div>
                    <label class="block text-xs font-medium text-gray-500 uppercase mb-1">OpenRouter API Key</label>
                    <input type="password" id="api-key-input" class="w-full bg-gray-50 dark:bg-dark-bg border border-gray-200 dark:border-dark-border rounded-lg px-4 py-2.5 focus:outline-none focus:border-brand-500 transition-colors" placeholder="sk-or-...">
                    <p class="text-xs text-gray-400 mt-1">Stored locally in your browser.</p>
                </div>
                <div>
                    <label class="block text-xs font-medium text-gray-500 uppercase mb-1">Model ID</label>
                    <input type="text" id="model-input" class="w-full bg-gray-50 dark:bg-dark-bg border border-gray-200 dark:border-dark-border rounded-lg px-4 py-2.5 focus:outline-none focus:border-brand-500 transition-colors" placeholder="deepseek/deepseek-r1:free">
                </div>
            </div>
            <div class="p-4 bg-gray-50 dark:bg-dark-bg flex justify-end">
                <button onclick="saveSettings()" class="bg-brand-600 text-white px-6 py-2 rounded-lg font-medium hover:bg-brand-700 transition-colors">Save</button>
            </div>
        </div>
    </div>

    <div id="system-prompt-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm p-4">
        <div class="bg-white dark:bg-dark-surface w-full max-w-lg rounded-2xl shadow-2xl overflow-hidden">
            <div class="p-6 border-b border-gray-100 dark:border-dark-border flex justify-between items-center">
                <h3 class="text-lg font-semibold">System Instructions</h3>
                <button onclick="closeModal('system-prompt-modal')" class="text-gray-500 hover:text-gray-900 dark:hover:text-white"><i class="ph ph-x text-xl"></i></button>
            </div>
            <div class="p-6">
                <p class="text-sm text-gray-500 mb-3">Define how the AI should behave for this chat.</p>
                <textarea id="system-prompt-input" rows="6" class="w-full bg-gray-50 dark:bg-dark-bg border border-gray-200 dark:border-dark-border rounded-lg px-4 py-3 focus:outline-none focus:border-brand-500 transition-colors resize-none" placeholder="You are a helpful coding assistant..."></textarea>
            </div>
            <div class="p-4 bg-gray-50 dark:bg-dark-bg flex justify-end gap-2">
                <button onclick="saveSystemPrompt()" class="bg-brand-600 text-white px-6 py-2 rounded-lg font-medium hover:bg-brand-700 transition-colors">Set Prompt</button>
            </div>
        </div>
    </div>

    <script>
        // ==========================================
        // CONSTANTS & STATE
        // ==========================================
        const API_URL = "https://openrouter.ai/api/v1/chat/completions";
        const DEFAULT_MODEL = "deepseek/deepseek-r1:free";
        
        let state = {
            apiKey: localStorage.getItem('gemini_clone_api_key') || '',
            model: localStorage.getItem('gemini_clone_model') || DEFAULT_MODEL,
            darkMode: localStorage.getItem('gemini_clone_dark_mode') === 'true',
            chats: JSON.parse(localStorage.getItem('gemini_clone_chats') || '[]'),
            currentChatId: null,
            isGenerating: false,
            controller: null // For aborting fetch
        };

        // ==========================================
        // INITIALIZATION
        // ==========================================
        document.addEventListener('DOMContentLoaded', () => {
            // Apply theme
            applyTheme();
            
            // Populate inputs
            document.getElementById('api-key-input').value = state.apiKey;
            document.getElementById('model-input').value = state.model;
            document.getElementById('current-model-display').innerText = state.model;
            
            // Load Chats
            if (state.chats.length === 0) {
                createNewChat(false); // Create initial chat without switching animation
            } else {
                // Load most recent
                loadChat(state.chats[0].id);
            }
            renderChatList();

            // Setup Markdown
            marked.setOptions({
                highlight: function(code, lang) {
                    const language = highlight.getLanguage(lang) ? lang : 'plaintext';
                    return highlight.highlight(code, { language }).value;
                },
                langPrefix: 'hljs language-'
            });

            // Remove Loader
            setTimeout(() => {
                const loader = document.getElementById('app-loader');
                loader.style.opacity = '0';
                loader.style.transition = 'opacity 0.5s ease';
                setTimeout(() => loader.remove(), 500);
                document.getElementById('welcome-view').style.opacity = '1';
            }, 500);
        });

        // ==========================================
        // CORE LOGIC
        // ==========================================

        function createNewChat(switchTo = true) {
            const newChat = {
                id: crypto.randomUUID(),
                title: 'New Chat',
                timestamp: Date.now(),
                messages: [],
                systemPrompt: ''
            };
            state.chats.unshift(newChat);
            saveState();
            renderChatList();
            if (switchTo) loadChat(newChat.id);
            if (window.innerWidth < 768) toggleSidebar(false); // Close mobile sidebar
            return newChat;
        }

        function loadChat(chatId) {
            let chat = state.chats.find(c => c.id === chatId);
            
            // Failsafe: If chat doesn't exist, default to first available or create new
            if (!chat) {
                if (state.chats.length > 0) {
                    chat = state.chats[0];
                    chatId = chat.id;
                } else {
                    chat = createNewChat(true);
                    return; // createNewChat calls loadChat
                }
            }

            state.currentChatId = chatId;
            
            // Update UI
            const container = document.getElementById('messages-container');
            container.innerHTML = ''; // Clear current view
            
            document.getElementById('system-prompt-input').value = chat.systemPrompt || '';

            if (chat.messages.length === 0) {
                document.getElementById('welcome-view').style.display = 'flex';
                setTimeout(() => document.getElementById('welcome-view').style.opacity = '1', 10);
            } else {
                document.getElementById('welcome-view').style.display = 'none';
                chat.messages.forEach(msg => appendMessageToDOM(msg.role, msg.content, false));
                scrollToBottom();
            }
            
            // Update Active State in Sidebar
            renderChatList();
        }

        function saveState() {
            localStorage.setItem('gemini_clone_chats', JSON.stringify(state.chats));
            localStorage.setItem('gemini_clone_api_key', state.apiKey);
            localStorage.setItem('gemini_clone_model', state.model);
            localStorage.setItem('gemini_clone_dark_mode', state.darkMode);
        }

        async function sendMessage() {
            if (state.isGenerating) return; // Prevent double submit
            
            const inputEl = document.getElementById('user-input');
            const content = inputEl.value.trim();
            
            if (!content) return;
            if (!state.apiKey) {
                openModal('settings-modal');
                alert("Please enter your OpenRouter API Key first.");
                return;
            }

            // --- FAILSAFE FIX: Ensure chat exists ---
            let currentChat = state.chats.find(c => c.id === state.currentChatId);
            if (!currentChat) {
                console.warn("Chat ID not found, creating new chat...");
                currentChat = createNewChat(true);
            }
            // ----------------------------------------

            // UI Updates
            inputEl.value = '';
            inputEl.style.height = 'auto'; // Reset height
            document.getElementById('welcome-view').style.display = 'none';
            
            // Add User Message
            addMessageToState('user', content);
            appendMessageToDOM('user', content);

            // Prepare AI Stream
            state.isGenerating = true;
            toggleSendButtonState(true);
            
            const aiMsgId = crypto.randomUUID();
            appendLoadingMessageToDOM(aiMsgId);

            try {
                // Re-fetch chat object to ensure latest state
                currentChat = state.chats.find(c => c.id === state.currentChatId); 
                const messagesPayload = [];
                
                // Add System Prompt if exists
                if (currentChat && currentChat.systemPrompt) {
                    messagesPayload.push({ role: "system", content: currentChat.systemPrompt });
                }
                
                // Add context (limit to last 10 messages for token savings in this demo)
                const contextMessages = currentChat.messages.slice(-10); 
                messagesPayload.push(...contextMessages);

                state.controller = new AbortController();
                
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${state.apiKey}`,
                        'HTTP-Referer': window.location.href,
                        'X-Title': 'Universal AI Chat',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        model: state.model,
                        messages: messagesPayload,
                        stream: true
                    }),
                    signal: state.controller.signal
                });

                if (!response.ok) throw new Error(`API Error: ${response.status}`);

                // Handle Streaming
                const reader = response.body.getReader();
                const decoder = new TextDecoder("utf-8");
                let aiContent = "";
                const aiMsgEl = document.getElementById(aiMsgId);
                const contentDiv = aiMsgEl.querySelector('.message-content');
                
                // Remove loading spinner
                contentDiv.innerHTML = '<span class="cursor-blink"></span>';

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;
                    
                    const chunk = decoder.decode(value, { stream: true });
                    const lines = chunk.split('\n');
                    
                    for (const line of lines) {
                        if (line.startsWith('data: ') && line !== 'data: [DONE]') {
                            try {
                                const json = JSON.parse(line.substring(6));
                                const delta = json.choices[0].delta?.content || "";
                                aiContent += delta;
                                
                                contentDiv.innerHTML = DOMPurify.sanitize(marked.parse(aiContent)) + '<span class="cursor-blink"></span>';
                                
                                scrollToBottom();
                            } catch (e) {
                                console.warn("Error parsing stream", e);
                            }
                        }
                    }
                }

                // Finalize
                contentDiv.querySelector('.cursor-blink')?.remove();
                addMessageToState('assistant', aiContent);
                
                // Auto-generate title if it's the first message
                if (currentChat.messages.length === 2) {
                    generateTitle(content);
                }

            } catch (error) {
                if (error.name !== 'AbortError') {
                    const errMsgEl = document.getElementById(aiMsgId);
                    if(errMsgEl) {
                        errMsgEl.querySelector('.message-content').innerHTML = `<span class="text-red-500">Error: ${error.message}</span>`;
                    }
                }
            } finally {
                state.isGenerating = false;
                state.controller = null;
                toggleSendButtonState(false);
                saveState();
            }
        }

        // ==========================================
        // UI HELPERS (DOM MANIPULATION)
        // ==========================================

        function appendMessageToDOM(role, content, animate = true) {
            const container = document.getElementById('messages-container');
            const isUser = role === 'user';
            
            const div = document.createElement('div');
            div.className = `flex w-full mb-6 ${isUser ? 'justify-end' : 'justify-start'} ${animate ? 'animate-fade-in-up' : ''}`;
            
            const bubble = document.createElement('div');
            bubble.className = `max-w-[85%] md:max-w-[75%] rounded-2xl px-5 py-3.5 shadow-sm text-sm leading-relaxed overflow-hidden ${
                isUser 
                ? 'bg-brand-600 text-white rounded-br-none' 
                : 'bg-white dark:bg-dark-surface border border-gray-100 dark:border-dark-border rounded-bl-none text-gray-800 dark:text-gray-100'
            }`;

            if (isUser) {
                bubble.innerText = content; // User text is plain
            } else {
                bubble.className += ' prose dark:prose-invert max-w-none'; // Markdown styles
                bubble.innerHTML = DOMPurify.sanitize(marked.parse(content));
            }

            div.appendChild(bubble);
            container.appendChild(div);
            scrollToBottom();
        }

        function appendLoadingMessageToDOM(id) {
            const container = document.getElementById('messages-container');
            const div = document.createElement('div');
            div.id = id;
            div.className = `flex w-full mb-6 justify-start animate-fade-in-up`;
            
            div.innerHTML = `
                <div class="max-w-[75%] bg-white dark:bg-dark-surface border border-gray-100 dark:border-dark-border rounded-2xl rounded-bl-none px-5 py-4 shadow-sm">
                    <div class="message-content">
                        <div class="flex gap-1 h-2 items-center">
                            <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 0ms"></div>
                            <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 150ms"></div>
                            <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 300ms"></div>
                        </div>
                    </div>
                </div>
            `;
            container.appendChild(div);
            scrollToBottom();
        }

        function renderChatList() {
            const list = document.getElementById('chat-history-list');
            list.innerHTML = '';
            
            state.chats.forEach(chat => {
                const isActive = chat.id === state.currentChatId;
                const item = document.createElement('button');
                item.className = `w-full text-left px-3 py-2.5 rounded-full text-sm truncate transition-colors flex items-center gap-2 ${
                    isActive 
                    ? 'bg-blue-100 dark:bg-blue-900/30 text-brand-600 dark:text-blue-400 font-medium' 
                    : 'text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-dark-bg'
                }`;
                item.onclick = () => {
                    loadChat(chat.id);
                    if (window.innerWidth < 768) toggleSidebar(false);
                };
                
                item.innerHTML = `
                    <i class="ph ${isActive ? 'ph-chat-circle-text' : 'ph-chat-circle'} text-lg"></i>
                    <span class="truncate flex-1">${chat.title}</span>
                `;
                list.appendChild(item);
            });
        }

        function addMessageToState(role, content) {
            const chatIndex = state.chats.findIndex(c => c.id === state.currentChatId);
            if (chatIndex !== -1) {
                state.chats[chatIndex].messages.push({ role, content });
                // Move chat to top
                const updatedChat = state.chats.splice(chatIndex, 1)[0];
                state.chats.unshift(updatedChat);
                saveState();
                renderChatList();
            }
        }

        async function generateTitle(firstUserMessage) {
            // Simple heuristic title or API call could go here. 
            // For now, just truncate user message.
            const chat = state.chats.find(c => c.id === state.currentChatId);
            if(chat) {
                chat.title = firstUserMessage.substring(0, 30) + (firstUserMessage.length > 30 ? '...' : '');
                saveState();
                renderChatList();
            }
        }

        // ==========================================
        // SETTINGS & UTILS
        // ==========================================

        function saveSettings() {
            const key = document.getElementById('api-key-input').value.trim();
            const model = document.getElementById('model-input').value.trim();
            
            if (key) state.apiKey = key;
            if (model) state.model = model;
            
            document.getElementById('current-model-display').innerText = state.model;
            saveState();
            closeModal('settings-modal');
        }

        function saveSystemPrompt() {
            const prompt = document.getElementById('system-prompt-input').value.trim();
            const chat = state.chats.find(c => c.id === state.currentChatId);
            if (chat) {
                chat.systemPrompt = prompt;
                saveState();
                closeModal('system-prompt-modal');
                alert("System prompt saved for this chat.");
            }
        }

        function deleteCurrentChat() {
            if (confirm("Delete this chat?")) {
                state.chats = state.chats.filter(c => c.id !== state.currentChatId);
                saveState();
                if (state.chats.length === 0) createNewChat();
                else loadChat(state.chats[0].id);
                document.getElementById('chat-options-dropdown').classList.add('hidden');
            }
        }

        function renameCurrentChat() {
            const newName = prompt("Enter new chat name:");
            if (newName) {
                const chat = state.chats.find(c => c.id === state.currentChatId);
                chat.title = newName;
                saveState();
                renderChatList();
                document.getElementById('chat-options-dropdown').classList.add('hidden');
            }
        }

        // Theme Logic
        function toggleDarkMode() {
            state.darkMode = !state.darkMode;
            applyTheme();
            saveState();
        }

        function applyTheme() {
            const html = document.documentElement;
            const icon = document.getElementById('theme-icon');
            const text = document.getElementById('theme-text');
            
            if (state.darkMode) {
                html.classList.add('dark');
                icon.classList.replace('ph-moon', 'ph-sun');
                text.innerText = "Light Mode";
            } else {
                html.classList.remove('dark');
                icon.classList.replace('ph-sun', 'ph-moon');
                text.innerText = "Dark Mode";
            }
        }

        // Sidebar Logic
        function toggleSidebar(forceState) {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebar-overlay');
            const isOpen = forceState !== undefined ? forceState : sidebar.classList.contains('-translate-x-full');
            
            if (isOpen === false) {
                 sidebar.classList.add('-translate-x-full');
                 overlay.classList.add('hidden');
            } else {
                sidebar.classList.remove('-translate-x-full');
                overlay.classList.remove('hidden');
            }
        }

        // Input Resizing
        function autoResize(textarea) {
            textarea.style.height = 'auto';
            textarea.style.height = textarea.scrollHeight + 'px';
        }

        function handleEnter(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        }

        function toggleSendButtonState(isLoading) {
            const btn = document.getElementById('send-btn');
            const icon = btn.querySelector('i');
            if (isLoading) {
                btn.disabled = true;
                icon.classList.replace('ph-paper-plane-right', 'ph-stop');
                btn.onclick = () => {
                    if (state.controller) state.controller.abort();
                };
                btn.disabled = false; // Allow clicking to stop
            } else {
                btn.disabled = false;
                icon.classList.replace('ph-stop', 'ph-paper-plane-right');
                btn.onclick = sendMessage;
            }
        }

        function scrollToBottom() {
            const container = document.getElementById('messages-container');
            container.scrollTop = container.scrollHeight;
        }

        // Modal Logic
        function openModal(id) { document.getElementById(id).classList.remove('hidden'); }
        function closeModal(id) { document.getElementById(id).classList.add('hidden'); }

        // Dropdown Logic
        function showChatOptions(e) {
            e.stopPropagation();
            const el = document.getElementById('chat-options-dropdown');
            el.classList.toggle('hidden');
        }

        // Close dropdowns on click outside
        window.onclick = function(event) {
            if (!event.target.matches('.ph-dots-three-vertical')) {
                document.getElementById('chat-options-dropdown').classList.add('hidden');
            }
        }
    </script>
</body>
</html>
